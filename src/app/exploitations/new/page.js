import {orderBy} from 'lodash-es'
import nextDynamic from 'next/dynamic'

import {getPointsPrelevement, getPreleveurs} from '@/app/api/points-prelevement.js'
import ExploitationCreationForm from '@/components/form/exploitation-creation-form.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPointPrelevementURL, getPointsPrelevementURL, getPreleveurURL} from '@/lib/urls.js'

const DynamicBreadcrumb = nextDynamic(
  () => import('@codegouvfr/react-dsfr/Breadcrumb')
)
export const dynamic = 'force-dynamic'

const Page = async ({searchParams}) => {
  const preleveurs = await getPreleveurs()
  const {idPoint, idPreleveur} = await searchParams
  const pointsPrelevement = await getPointsPrelevement()

  const breadcrumbSegments = [{
    label: 'Points de prélèvement',
    linkProps: {
      href: getPointsPrelevementURL()
    }
  }]

  const defaultPreleveur = idPreleveur ? preleveurs.find(p => p._id === idPreleveur) : null
  const defaultPointPrelevement = idPoint ? pointsPrelevement.find(p => p._id === idPoint) : null

  if (defaultPreleveur) {
    breadcrumbSegments.push({
      label: `${defaultPreleveur.id_preleveur} - ${defaultPreleveur.nom}`,
      linkProps: {
        href: getPreleveurURL(defaultPreleveur)
      }
    })
  }

  if (defaultPointPrelevement) {
    breadcrumbSegments.push({
      label: `${defaultPointPrelevement.id_point} - ${defaultPointPrelevement.nom}`,
      linkProps: {
        href: getPointPrelevementURL(defaultPointPrelevement)
      }
    })
  }

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4'>
        <DynamicBreadcrumb
          currentPageLabel="Création d'une exploitation"
          segments={breadcrumbSegments}
        />
        <ExploitationCreationForm
          idPoint={idPoint}
          defaultPreleveur={defaultPreleveur}
          defaultPointPrelevement={defaultPointPrelevement}
          pointsPrelevement={orderBy(pointsPrelevement, ['nom'], ['asc'])}
          preleveurs={preleveurs}
        />
      </div>
    </>
  )
}

export default Page
