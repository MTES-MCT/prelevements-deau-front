import dynamic from 'next/dynamic'
import {notFound} from 'next/navigation'

import ExploitationEditionForm from '@/components/form/exploitation-edition-form.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {
  getExploitationAction,
  getPointPrelevementAction,
  getPreleveurAction
} from '@/server/actions/index.js'

const DynamicBreadcrumb = dynamic(
  () => import('@codegouvfr/react-dsfr/Breadcrumb')
)

const Page = async ({params}) => {
  const {id} = await params
  const exploitationResult = await getExploitationAction(id)

  if (!exploitationResult.success || !exploitationResult.data) {
    notFound()
  }

  const exploitation = exploitationResult.data

  const pointResult = await getPointPrelevementAction(exploitation.point)
  const preleveurResult = await getPreleveurAction(exploitation.preleveur)

  // Check for success before extracting data
  if (!pointResult.success || !preleveurResult.success) {
    notFound()
  }

  const point = pointResult.data
  const preleveur = preleveurResult.data

  return (
    <div className='fr-container '>
      <StartDsfrOnHydration />
      <div className='p-5'>
        <DynamicBreadcrumb
          currentPageLabel='Édition'
          homeLinkProps={{
            href: '/'
          }}
          segments={[
            {
              label: 'Préleveurs',
              linkProps: {
                href: '/preleveurs'
              }
            },
            {
              label: preleveur.raison_sociale || `${preleveur.prenom} ${preleveur.nom}`,
              linkProps: {
                href: `/preleveurs/${preleveur.id_preleveur}`
              }
            },
            {
              label: `Exploitation ${exploitation.id_exploitation}`,
              linkProps: {
                href: `/exploitations/${exploitation.id_exploitation}`
              }
            }
          ]}
        />
      </div>
      <ExploitationEditionForm
        exploitation={exploitation}
        point={point}
        preleveur={preleveur}
      />
    </div>
  )
}

export default Page
