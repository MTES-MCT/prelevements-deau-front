import {fr} from '@codegouvfr/react-dsfr'
import Alert from '@codegouvfr/react-dsfr/Alert'
import Button from '@codegouvfr/react-dsfr/Button'
import Tag from '@codegouvfr/react-dsfr/Tag'
import {WavesOutlined} from '@mui/icons-material'
import {Grid2, Typography} from '@mui/material'
import Link from 'next/link'
import {notFound} from 'next/navigation'

import Document from '@/components/documents/document.js'
import ExploitationItem from '@/components/exploitations/exploitation-item.js'
import {RequireEditor} from '@/components/permissions/index.js'
import PointLocalisation from '@/components/points-prelevement/point-localisation.js'
import SeriesExplorer from '@/components/points-prelevement/series-explorer.js'
import ReglesListCard from '@/components/regles/regles-list-card.js'
import DividerSection from '@/components/ui/DividerSection/index.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPreleveurTitle} from '@/lib/preleveurs.js'
import {getPointPrelevementURL} from '@/lib/urls.js'
import {
  getExploitationAction,
  getReglesFromPreleveurAction,
  getAggregatedSeriesOptionsAction
} from '@/server/actions/index.js'

const Page = async ({params}) => {
  const {id} = await params

  const exploitationResult = await getExploitationAction(id)

  // Check for success before extracting data
  if (!exploitationResult.success || !exploitationResult.data) {
    notFound()
  }

  const exploitation = exploitationResult.data
  const {declarant} = exploitation
  const {pointPrelevement} = exploitation

  const seriesOptionsResult = await getAggregatedSeriesOptionsAction({
    pointIds: [pointPrelevement.id],
    preleveurId: declarant.id
  })
  const seriesOptions = seriesOptionsResult.success ? seriesOptionsResult.data : null

  const preleveurReglesResult = await getReglesFromPreleveurAction(declarant.id)
  const preleveurRegles = preleveurReglesResult.success ? (preleveurReglesResult.data || []) : []

  // Filter the rules that belong to this exploitation
  const exploitationRegles = preleveurRegles.filter(regle =>
    regle.exploitations.some(expl => expl.id === exploitation.id)
  )

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4 flex flex-col gap-4'>
        <ExploitationItem exploitation={exploitation}>
          <div className='flex flex-col gap-4'>
            {exploitation.remarque && (
              <Alert severity='info' description={exploitation.remarque} />
            )}

            <div className='fr-mb-2w flex justify-between items-start'>
              <div>
                <Typography>

                  <span
                    className='fr-icon-user-line pr-2'
                    aria-hidden='true'
                    style={{
                      color: fr.colors.decisions.text.actionHigh.blueFrance.default
                    }}
                  />
                  { getPreleveurTitle(declarant)}
                </Typography>
              </div>
              <RequireEditor>
                <Button
                  priority='secondary'
                  size='small'
                  linkProps={{
                    href: `/exploitations/${exploitation.id}/edit`
                  }}
                >
                  Modifier l&apos;exploitation
                </Button>
              </RequireEditor>
            </div>
            <div>
              <span
                className='fr-icon-map-pin-2-line pr-2'
                aria-hidden='true'
                style={{
                  color: fr.colors.decisions.text.actionHigh.blueFrance.default
                }}
              />
              <Link href={getPointPrelevementURL(pointPrelevement)}>
                {pointPrelevement.name}
              </Link>
              <Tag
                small
                severity='info'
                className='pl-2 ml-3'
                style={{
                  backgroundColor: fr.colors.decisions.background.actionLow.blueFrance.default,
                  color: fr.colors.decisions.text.actionHigh.blueFrance.default
                }}
              >
                <span className='pr-2'>
                  <WavesOutlined />
                </span>
                {pointPrelevement.waterBodyType}
              </Tag>
            </div>
          </div>
        </ExploitationItem>

        <PointLocalisation pointPrelevement={pointPrelevement} />

        <SeriesExplorer
          preleveurId={declarant.id}
          pointIds={[pointPrelevement.id]}
          seriesOptions={seriesOptions}
          startDate={exploitation.startDate}
          endDate={exploitation.endDate}
        />

        <div>
          <Typography
            gutterBottom
            variant='h5'
          >
            Ressources
          </Typography>
          <Grid2>
            <DividerSection title='Documents'>
              {exploitation?.documents?.length > 0 ? (
                exploitation?.documents?.map(document => (
                  <Document
                    key={document.id}
                    document={document}
                  />
                ))
              ) : (
                <Typography>Aucun document</Typography>
              )}
            </DividerSection>
          </Grid2>

          <Grid2 className='fr-mb-5w'>
            <DividerSection title='Règles'>
              {exploitationRegles.length > 0 ? (
                <ReglesListCard
                  hasExploitations={exploitationRegles.length > 0}
                  preleveurId={declarant.id}
                  regles={exploitationRegles}
                />
              ) : (
                <Typography>Aucune règle</Typography>
              )}
            </DividerSection>
          </Grid2>
        </div>
      </div>
    </>
  )
}

export default Page
