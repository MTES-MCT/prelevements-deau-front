import {fr} from '@codegouvfr/react-dsfr'
import Tag from '@codegouvfr/react-dsfr/Tag'
import {WavesOutlined} from '@mui/icons-material'
import {Grid2, Typography} from '@mui/material'
import {uniqueId} from 'lodash-es'
import Link from 'next/link'

import {
  getExploitation,
  getPointPrelevement,
  getPreleveur
} from '@/app/api/points-prelevement.js'
import Document from '@/components/documents/document.js'
import ExploitationItem from '@/components/exploitations/exploitation-item.js'
import Modalite from '@/components/modalite.js'
import Regles from '@/components/regles.js'
import DividerSection from '@/components/ui/DividerSection/index.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPointPrelevementURL} from '@/lib/urls.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const Page = async ({params}) => {
  const {id} = await params

  const exploitation = await getExploitation(id)
  const point = await getPointPrelevement(exploitation.point)
  const preleveur = await getPreleveur(exploitation.preleveur)

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4'>
        <ExploitationItem exploitation={exploitation}>
          <div className='fr-mb-2w'>
            <span
              className='fr-icon-user-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={`/preleveurs/${preleveur.id_preleveur}`}>
              {displayPreleveur(preleveur)}
            </Link>
          </div>
          <div>
            <span
              className='fr-icon-map-pin-2-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={getPointPrelevementURL(point)}>
              {point.nom}
            </Link>
            <Tag
              small
              severity='info'
              className='pl-2 ml-3'
              style={{
                backgroundColor: fr.colors.decisions.background.actionLow.blueFrance.default,
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            >
              <span className='pr-2'>
                <WavesOutlined />
              </span>
              {point.type_milieu}
            </Tag>
          </div>
        </ExploitationItem>

        <div className='fr-h6 fr-mt-5w'>Ressources</div>
        <Grid2>
          <DividerSection title='Documents'>
            {exploitation?.documents?.map(document => (
              <Document key={document.id_document} document={document} />
            ))}
          </DividerSection>
        </Grid2>

        {exploitation?.modalites?.length > 0 && (
          <DividerSection title='Modalités'>
            {exploitation?.modalites?.map(modalite => (
              <Modalite
                key={uniqueId}
                modalite={modalite}
              />
            ))}
          </DividerSection>
        )}

        <Grid2 className='fr-mb-5w'>
          <DividerSection title='Règles'>
            {exploitation.regles.length > 0 ? (
              <Regles
                regles={exploitation.regles}
                documents={exploitation.documents}
              />
            ) : (
              <Typography>Aucune règle</Typography>
            )}
          </DividerSection>
        </Grid2>
      </div>
    </>
  )
}

export default Page
