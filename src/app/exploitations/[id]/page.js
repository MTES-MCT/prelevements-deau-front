import {fr} from '@codegouvfr/react-dsfr'
import Alert from '@codegouvfr/react-dsfr/Alert'
import Button from '@codegouvfr/react-dsfr/Button'
import Tag from '@codegouvfr/react-dsfr/Tag'
import {WavesOutlined} from '@mui/icons-material'
import {Grid2, Typography} from '@mui/material'
import Link from 'next/link'
import {notFound} from 'next/navigation'

import Document from '@/components/documents/document.js'
import ExploitationItem from '@/components/exploitations/exploitation-item.js'
import {RequireEditor} from '@/components/permissions/index.js'
import PointLocalisation from '@/components/points-prelevement/point-localisation.js'
import SeriesExplorer from '@/components/points-prelevement/series-explorer.js'
import ReglesListCard from '@/components/regles/regles-list-card.js'
import DividerSection from '@/components/ui/DividerSection/index.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPointPrelevementURL} from '@/lib/urls.js'
import {
  getExploitationAction,
  getPointPrelevementAction,
  getPreleveurAction,
  getReglesFromPreleveurAction,
  getAggregatedSeriesOptionsAction
} from '@/server/actions/index.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const Page = async ({params}) => {
  const {id} = await params

  const exploitationResult = await getExploitationAction(id)

  // Check for success before extracting data
  if (!exploitationResult.success || !exploitationResult.data) {
    notFound()
  }

  const exploitation = exploitationResult.data
  const pointResult = await getPointPrelevementAction(exploitation.point)
  const preleveurResult = await getPreleveurAction(exploitation.preleveur)

  // Check for success before extracting data
  if (!pointResult.success || !preleveurResult.success) {
    notFound()
  }

  const point = pointResult.data
  const preleveur = preleveurResult.data
  const seriesOptionsResult = await getAggregatedSeriesOptionsAction({pointIds: [exploitation.point], preleveurId: preleveur._id})
  const seriesOptions = seriesOptionsResult.success ? seriesOptionsResult.data : null
  const preleveurReglesResult = await getReglesFromPreleveurAction(preleveur._id)
  const preleveurRegles = preleveurReglesResult.success ? (preleveurReglesResult.data || []) : []

  // Filter the rules that belong to this exploitation
  const exploitationRegles = preleveurRegles.filter(regle =>
    regle.exploitations.some(expl => expl._id === exploitation._id)
  )

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4 flex flex-col gap-4'>
        <ExploitationItem exploitation={exploitation}>
          <div className='flex flex-col gap-4'>
            {exploitation.remarque && (
              <Alert severity='info' description={exploitation.remarque} />
            )}

            <div className='fr-mb-2w flex justify-between items-start'>
              <div>
                <span
                  className='fr-icon-user-line pr-2'
                  aria-hidden='true'
                  style={{
                    color: fr.colors.decisions.text.actionHigh.blueFrance.default
                  }}
                />
                <Link href={`/preleveurs/${preleveur.id_preleveur}`}>
                  {displayPreleveur(preleveur)}
                </Link>
              </div>
              <RequireEditor>
                <Button
                  priority='secondary'
                  size='small'
                  linkProps={{
                    href: `/exploitations/${exploitation._id}/edit`
                  }}
                >
                  Modifier l&apos;exploitation
                </Button>
              </RequireEditor>
            </div>
            <div>
              <span
                className='fr-icon-map-pin-2-line pr-2'
                aria-hidden='true'
                style={{
                  color: fr.colors.decisions.text.actionHigh.blueFrance.default
                }}
              />
              <Link href={getPointPrelevementURL(point)}>
                {point.nom}
              </Link>
              <Tag
                small
                severity='info'
                className='pl-2 ml-3'
                style={{
                  backgroundColor: fr.colors.decisions.background.actionLow.blueFrance.default,
                  color: fr.colors.decisions.text.actionHigh.blueFrance.default
                }}
              >
                <span className='pr-2'>
                  <WavesOutlined />
                </span>
                {point.type_milieu}
              </Tag>
            </div>
          </div>
        </ExploitationItem>

        <PointLocalisation pointPrelevement={point} />

        <SeriesExplorer
          preleveurId={preleveur._id}
          pointIds={[point.id_point]}
          seriesOptions={seriesOptions}
          startDate={exploitation.date_debut}
          endDate={exploitation.date_fin}
        />

        <div>
          <Typography
            gutterBottom
            variant='h5'
          >
            Ressources
          </Typography>
          <Grid2>
            <DividerSection title='Documents'>
              {exploitation?.documents?.map(document => (
                <Document
                  key={document._id}
                  document={document}
                />
              ))}
            </DividerSection>
          </Grid2>

          <Grid2 className='fr-mb-5w'>
            <DividerSection title='Règles'>
              {exploitationRegles.length > 0 ? (
                <ReglesListCard
                  hasExploitations={exploitationRegles.length > 0}
                  preleveurId={preleveur.id_preleveur}
                  regles={exploitationRegles}
                />
              ) : (
                <Typography>Aucune règle</Typography>
              )}
            </DividerSection>
          </Grid2>
        </div>
      </div>
    </>
  )
}

export default Page
