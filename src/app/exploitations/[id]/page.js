import {fr} from '@codegouvfr/react-dsfr'
import Tag from '@codegouvfr/react-dsfr/Tag'
import {WavesOutlined} from '@mui/icons-material'
import {Divider, Grid2, Typography} from '@mui/material'
import Link from 'next/link'

import {
  getExploitation,
  getPointPrelevement,
  getPreleveur
} from '@/app/api/points-prelevement.js'
import Document from '@/components/document.js'
import ExploitationItem from '@/components/exploitations/exploitation-item.js'
import Regles from '@/components/regles.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPointPrelevementURL} from '@/lib/urls.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const Page = async ({params}) => {
  const {id} = await params

  const exploitation = await getExploitation(id)
  const point = await getPointPrelevement(exploitation.point)
  const preleveur = await getPreleveur(exploitation.preleveur)

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4'>
        <ExploitationItem exploitation={exploitation}>
          <div className='fr-mb-2w'>
            <span
              className='fr-icon-user-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={`/preleveurs/${preleveur.id_preleveur}`}>
              {displayPreleveur(preleveur)}
            </Link>
          </div>
          <div>
            <span
              className='fr-icon-map-pin-2-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={getPointPrelevementURL(point)}>
              {point.nom}
            </Link>
            <Tag
              small
              severity='info'
              className='pl-2 ml-3'
              style={{
                backgroundColor: fr.colors.decisions.background.actionLow.blueFrance.default,
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            >
              <span className='pr-2'>
                <WavesOutlined />
              </span>
              {point.type_milieu}
            </Tag>
          </div>
        </ExploitationItem>

        <div className='fr-h6 fr-mt-5w'>Ressources</div>
        <Grid2>
          <Divider sx={{m: 2}} textAlign='left'>
            Documents
          </Divider>
          {exploitation?.documents?.map(document => (
            <Document key={document.id_document} document={document} />
          ))}
        </Grid2>
        <Grid2 className='fr-mb-5w'>
          <Divider sx={{m: 2}} textAlign='left'>
            Règles
          </Divider>
          {exploitation.regles.length > 0 ? (
            <Regles
              regles={exploitation.regles}
              documents={exploitation.documents}
            />
          ) : (
            <Typography>Aucune règle</Typography>
          )}
        </Grid2>
      </div>
    </>
  )
}

export default Page
