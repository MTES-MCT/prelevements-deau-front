import {fr} from '@codegouvfr/react-dsfr'
import Tag from '@codegouvfr/react-dsfr/Tag'
import {WavesOutlined} from '@mui/icons-material'
import {Grid2, Typography} from '@mui/material'
import Link from 'next/link'

import {
  getExploitation,
  getPointPrelevement,
  getPreleveur,
  getReglesFromPreleveur
} from '@/app/api/points-prelevement.js'
import {getAggregatedSeriesOptions} from '@/app/api/series.js'
import Document from '@/components/documents/document.js'
import ExploitationItem from '@/components/exploitations/exploitation-item.js'
import PointLocalisation from '@/components/points-prelevement/point-localisation.js'
import SeriesExplorer from '@/components/points-prelevement/series-explorer.js'
import Regles from '@/components/regles.js'
import DividerSection from '@/components/ui/DividerSection/index.js'
import {StartDsfrOnHydration} from '@/dsfr-bootstrap/index.js'
import {getPointPrelevementURL} from '@/lib/urls.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const Page = async ({params}) => {
  const {id} = await params

  const exploitation = await getExploitation(id)
  const point = await getPointPrelevement(exploitation.point)
  const preleveur = await getPreleveur(exploitation.preleveur)
  const seriesOptions = await getAggregatedSeriesOptions({pointIds: [exploitation.point], preleveurId: preleveur._id})
  const preleveurRegles = await getReglesFromPreleveur(preleveur._id)

  // Filter the rules that belong to this exploitation
  const exploitationRegles = preleveurRegles.filter(regle =>
    regle.exploitations.some(expl => expl._id === exploitation._id)
  )

  return (
    <>
      <StartDsfrOnHydration />
      <div className='fr-container mt-4 flex flex-col gap-4'>
        <ExploitationItem exploitation={exploitation}>
          <div className='fr-mb-2w'>
            <span
              className='fr-icon-user-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={`/preleveurs/${preleveur.id_preleveur}`}>
              {displayPreleveur(preleveur)}
            </Link>
          </div>
          <div>
            <span
              className='fr-icon-map-pin-2-line pr-2'
              aria-hidden='true'
              style={{
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            />
            <Link href={getPointPrelevementURL(point)}>
              {point.nom}
            </Link>
            <Tag
              small
              severity='info'
              className='pl-2 ml-3'
              style={{
                backgroundColor: fr.colors.decisions.background.actionLow.blueFrance.default,
                color: fr.colors.decisions.text.actionHigh.blueFrance.default
              }}
            >
              <span className='pr-2'>
                <WavesOutlined />
              </span>
              {point.type_milieu}
            </Tag>
          </div>
        </ExploitationItem>

        <PointLocalisation pointPrelevement={point} />

        <SeriesExplorer
          preleveurId={preleveur._id}
          pointIds={[point.id_point]}
          seriesOptions={seriesOptions}
          startDate={exploitation.date_debut}
          endDate={exploitation.date_fin}
        />

        <div>
          <Typography
            gutterBottom
            variant='h5'
          >
            Ressources
          </Typography>
          <Grid2>
            <DividerSection title='Documents'>
              {exploitation?.documents?.map(document => (
                <Document key={document._id} document={document} />
              ))}
            </DividerSection>
          </Grid2>

          <Grid2 className='fr-mb-5w'>
            <DividerSection title='Règles'>
              {exploitationRegles.length > 0 ? (
                <Regles regles={exploitationRegles} />
              ) : (
                <Typography>Aucune règle</Typography>
              )}
            </DividerSection>
          </Grid2>
        </div>
      </div>
    </>
  )
}

export default Page
