'use server'

import {revalidatePath} from 'next/cache'

import {
  fetchJSON,
  withErrorHandling
} from '@/server/api-wrapper.js'

// ============================================================================
// Exploitations
// ============================================================================

/**
 * Get a single exploitation by ID
 * @param {string} exploitationId - Exploitation ID
 * @returns {Promise<Object>} - Result object
 */
export async function getExploitationAction(exploitationId) {
  return withErrorHandling(async () => fetchJSON(`api/exploitations/${exploitationId}`))
}

/**
 * Create a new exploitation
 * @param {Object} payload - Exploitation data
 * @returns {Promise<Object>} - Result object
 */
export async function createExploitationAction(payload) {
  return withErrorHandling(async () => {
    const result = await fetchJSON('api/exploitations', {
      method: 'POST',
      body: payload
    })
    revalidatePath('/exploitations')
    if (payload.id_point) {
      revalidatePath(`/points-prelevement/${payload.id_point}`)
    }

    if (payload.id_preleveur) {
      revalidatePath(`/preleveurs/${payload.id_preleveur}`)
    }

    return result
  })
}

/**
 * Update an exploitation
 * @param {string} idExploitation - Exploitation ID
 * @param {Object} payload - Updated exploitation data
 * @returns {Promise<Object>} - Result object
 */
export async function updateExploitationAction(idExploitation, payload) {
  return withErrorHandling(async () => {
    const result = await fetchJSON(`api/exploitations/${idExploitation}`, {
      method: 'PUT',
      body: payload
    })
    revalidatePath(`/exploitations/${idExploitation}`)
    revalidatePath('/exploitations')
    return result
  })
}

/**
 * Delete an exploitation
 * @param {string} exploitationId - Exploitation ID
 * @returns {Promise<Object>} - Result object
 */
export async function deleteExploitationAction(exploitationId) {
  return withErrorHandling(async () => {
    const result = await fetchJSON(`api/exploitations/${exploitationId}`, {
      method: 'DELETE'
    })
    revalidatePath('/exploitations')
    return result
  })
}

/**
 * Get documents for an exploitation
 * @param {string} exploitationId - Exploitation ID
 * @returns {Promise<Object>} - Result object
 */
export async function getExploitationDocumentsAction(exploitationId) {
  return withErrorHandling(async () => {
    try {
      return await fetchJSON(`api/exploitations/${exploitationId}/documents`)
    } catch (error) {
      // Return empty array on error (consistent with original behavior)
      if (error.code === 404) {
        return []
      }

      throw error
    }
  })
}
