/* eslint-disable camelcase */
'use client'

import {useState} from 'react'

import Button from '@codegouvfr/react-dsfr/Button'
import {Input} from '@codegouvfr/react-dsfr/Input'
import {Select} from '@codegouvfr/react-dsfr/SelectNext'
import {Tooltip} from '@codegouvfr/react-dsfr/Tooltip'
import InfoOutlined from '@mui/icons-material/InfoOutlined'
import {
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  Typography
} from '@mui/material'
import dynamic from 'next/dynamic'
import Link from 'next/link'
import {useRouter} from 'next/navigation'

import {deleteExploitationAction, updateExploitationAction} from '@/server/actions/index.js'
import {emptyStringToNull} from '@/utils/string.js'

const DynamicCheckbox = dynamic(
  () => import('@codegouvfr/react-dsfr/Checkbox'),
  {ssr: false}
)

const statutsExploitation = [
  'En activité',
  'Terminée',
  'Abandonnée',
  'Non renseigné'
]

const usagesExploitation = [
  'Eau potable',
  'Agriculture',
  'Camion citerne',
  'Eau embouteillée',
  'Hydroélectricité',
  'Industrie',
  'Thermalisme',
  'Non renseigné',
  'Autre'
]

/**
 * Transform API exploitation to form state
 */
const transformExploitationForForm = exploitation => ({
  date_debut: exploitation.date_debut?.split('T')[0] || '',
  date_fin: exploitation.date_fin?.split('T')[0] || '',
  statut: exploitation.statut || '',
  usages: exploitation.usages || [],
  remarque: exploitation.remarque || '',
  raison_abandon: exploitation.raison_abandon || ''
})

const ExploitationEditionForm = ({
  exploitation,
  point,
  preleveur
}) => {
  const router = useRouter()
  const [formData, setFormData] = useState(transformExploitationForForm(exploitation))
  const [error, setError] = useState(null)
  const [validationErrors, setValidationErrors] = useState([])
  const [isDialogOpen, setIsDialogOpen] = useState(false)
  const [isSubmitting, setIsSubmitting] = useState(false)

  const isStatutAbandonnee = formData.statut === 'Abandonnée'

  const isFormValid = formData.date_debut
    && formData.statut
    && formData.usages?.length > 0

  const handleUsageChange = (usage, checked) => {
    setFormData(prev => {
      const newUsages = checked
        ? [...prev.usages, usage]
        : prev.usages.filter(u => u !== usage)
      return {...prev, usages: newUsages}
    })
  }

  const getFieldError = field => {
    const err = validationErrors.find(e => e.path?.includes(field))
    return err?.message
  }

  const handleSubmit = async () => {
    setError(null)
    setValidationErrors([])
    setIsSubmitting(true)

    try {
      const cleanedPayload = emptyStringToNull(formData)
      const response = await updateExploitationAction(exploitation._id, cleanedPayload)

      if (!response.success) {
        if (response.validationErrors) {
          setValidationErrors(response.validationErrors)
        } else {
          setError(response.error)
        }
      } else if (response.data._id || response.data.id_exploitation) {
        router.push(`/exploitations/${exploitation.id_exploitation}`)
      } else {
        setError('Une erreur inattendue est survenue')
      }
    } catch (error_) {
      setError(error_.message)
    } finally {
      setIsSubmitting(false)
    }
  }

  const handleDeleteExploitation = async () => {
    setError(null)
    setIsSubmitting(true)

    try {
      const response = await deleteExploitationAction(exploitation._id)

      if (!response.success) {
        setIsDialogOpen(false)
        setError(response.error)
        return
      }

      router.push(`/preleveurs/${preleveur.id_preleveur}`)
    } catch (error_) {
      setError(error_.message)
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className='fr-container'>
      <Typography sx={{pb: 5}} variant='h3'>
        Édition de l&apos;exploitation
      </Typography>

      <div className='mb-6 p-4 rounded border border-gray-200'>
        <Typography gutterBottom fontWeight='bold' variant='subtitle1'>
          Informations liées (non modifiables)
        </Typography>
        <div className='grid grid-cols-2 gap-4'>
          <div>
            <Typography color='textSecondary' variant='body2'>Point de prélèvement</Typography>
            <Link href={`/points-prelevement/${point.id_point}`}>
              {point.nom || `Point ${point.id_point}`}
            </Link>
          </div>
          <div>
            <Typography color='textSecondary' variant='body2'>Préleveur</Typography>
            <Link href={`/preleveurs/${preleveur.id_preleveur}`}>
              {preleveur.raison_sociale || `${preleveur.prenom} ${preleveur.nom}`}
            </Link>
          </div>
        </div>
      </div>

      <div className='w-full grid grid-cols-2 gap-4'>
        <Input
          label="Début d'exploitation *"
          state={getFieldError('date_debut') ? 'error' : 'default'}
          stateRelatedMessage={getFieldError('date_debut')}
          nativeInputProps={{
            type: 'date',
            value: formData.date_debut,
            onChange: e => setFormData(prev => ({...prev, date_debut: e.target.value}))
          }}
        />
        <Input
          label="Fin d'exploitation"
          state={getFieldError('date_fin') ? 'error' : 'default'}
          stateRelatedMessage={getFieldError('date_fin')}
          nativeInputProps={{
            type: 'date',
            value: formData.date_fin,
            onChange: e => setFormData(prev => ({...prev, date_fin: e.target.value}))
          }}
        />
      </div>

      <Select
        label={
          <>
            <span className='pr-2'>Statut *</span>
            <Tooltip
              kind='hover'
              title={
                <>
                  <p className='p-2'><b><u>En activité</u> :</b> Exploitation qui fait actuellement encore l&apos;objet de prélèvement.</p>
                  <p className='p-2'><b><u>Terminée</u> :</b> Exploitation arrêtée sans que cela soit dû à une raison technique particulière.</p>
                  <p className='p-2'><b><u>Abandonnée</u> :</b> Il y a une raison technique qui ne permet plus l&apos;exploitation du point de prélèvement pour l&apos;usage visé (ex : contamination par les pesticides).</p>
                  <p className='p-2'><b><u>Non renseigné</u> :</b> Pas d&apos;information sur l&apos;activité de l&apos;exploitation.</p>
                </>
              }
            />
          </>
        }
        options={[
          {value: '', label: '-- Sélectionner --', disabled: true},
          ...statutsExploitation.map(statut => ({
            value: statut,
            label: statut
          }))
        ]}
        placeholder='Sélectionner un statut'
        state={getFieldError('statut') ? 'error' : 'default'}
        stateRelatedMessage={getFieldError('statut')}
        nativeSelectProps={{
          value: formData.statut,
          onChange: e => setFormData(prev => ({...prev, statut: e.target.value}))
        }}
      />

      {isStatutAbandonnee && (
        <Input
          textArea
          label="Raison de l'abandon"
          state={getFieldError('raison_abandon') ? 'error' : 'default'}
          stateRelatedMessage={getFieldError('raison_abandon')}
          nativeTextAreaProps={{
            placeholder: 'Indiquer la raison de l\'abandon',
            value: formData.raison_abandon,
            onChange: e => setFormData(prev => ({...prev, raison_abandon: e.target.value}))
          }}
        />
      )}

      <DynamicCheckbox
        small
        legend='Usages *'
        options={usagesExploitation.map(usage => ({
          label: usage,
          nativeInputProps: {
            checked: formData.usages.includes(usage),
            onChange: e => handleUsageChange(usage, e.target.checked)
          }
        }))}
        orientation='horizontal'
        state={getFieldError('usages') ? 'error' : 'default'}
        stateRelatedMessage={getFieldError('usages')}
      />

      <Input
        textArea
        label='Remarque'
        state={getFieldError('remarque') ? 'error' : 'default'}
        stateRelatedMessage={getFieldError('remarque')}
        nativeTextAreaProps={{
          placeholder: 'Entrer une remarque',
          value: formData.remarque,
          onChange: e => setFormData(prev => ({...prev, remarque: e.target.value}))
        }}
      />

      <div className='border border-red-500 rounded-sm p-5 mt-6'>
        <div className='text-red-500'>
          <InfoOutlined className='mr-3' />
          Action sensible : Supprimer l&apos;exploitation
        </div>
        <div className='ml-8'>
          Cette action est irréversible et peut avoir des conséquences importantes.
        </div>
        <div className='ml-8 mt-5'>
          <Button
            priority='secondary'
            style={{
              color: 'red',
              boxShadow: '0 0 0 1px red'
            }}
            onClick={() => setIsDialogOpen(true)}
          >
            Supprimer
          </Button>
        </div>
        <Dialog
          maxWidth='md'
          open={isDialogOpen}
          onClose={() => setIsDialogOpen(false)}
        >
          <DialogTitle>
            <InfoOutlined className='mr-3' />
            Confirmer la suppression de l&apos;exploitation
          </DialogTitle>
          <DialogContent>
            <p>Êtes-vous sûr de vouloir supprimer cette exploitation ?</p>
            <p className='mt-3'>
              <strong>Conséquences :</strong>
            </p>
            <ul className='list-disc ml-5 mt-2'>
              <li>Cette exploitation sera définitivement supprimée.</li>
              <li>Les règles associées à cette exploitation seront désassociées.</li>
              <li>Les séries temporelles liées à cette exploitation ne seront plus visibles dans ce contexte.</li>
              <li>Cette action est irréversible.</li>
            </ul>
          </DialogContent>
          <DialogActions className='m-3'>
            <Button
              priority='secondary'
              onClick={() => setIsDialogOpen(false)}
            >
              Annuler
            </Button>
            <Button
              disabled={isSubmitting}
              style={{backgroundColor: 'red'}}
              onClick={handleDeleteExploitation}
            >
              Supprimer cette exploitation
            </Button>
          </DialogActions>
        </Dialog>
      </div>

      {error && (
        <div className='text-center p-5 pt-10 text-red-500'>
          <p><b>Un problème est survenu :</b></p>
          {error}
        </div>
      )}

      {validationErrors?.length > 0 && !validationErrors.some(e => e.path) && (
        <div className='text-center p-5 text-red-500'>
          <p><b>{validationErrors.length === 1 ? 'Problème de validation :' : 'Problèmes de validation :'}</b></p>
          {validationErrors.map(err => (
            <p key={err.message}>{err.message}</p>
          ))}
        </div>
      )}

      <div className='w-full flex justify-center p-5 my-5'>
        <Button
          disabled={!isFormValid || isSubmitting}
          onClick={handleSubmit}
        >
          {isSubmitting ? 'Enregistrement...' : 'Enregistrer les modifications'}
        </Button>
      </div>
    </div>
  )
}

export default ExploitationEditionForm
