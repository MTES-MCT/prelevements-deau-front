/* eslint-disable camelcase */
'use client'

import {useEffect, useState} from 'react'

import Alert from '@codegouvfr/react-dsfr/Alert'
import Button from '@codegouvfr/react-dsfr/Button'
import {Input} from '@codegouvfr/react-dsfr/Input'
import {SearchBar} from '@codegouvfr/react-dsfr/SearchBar'
import {Select} from '@codegouvfr/react-dsfr/SelectNext'
import {Tooltip} from '@codegouvfr/react-dsfr/Tooltip'
import {Typography, Box, CircularProgress} from '@mui/material'
import dynamic from 'next/dynamic'
import {useRouter} from 'next/navigation'

import {createExploitation, getDocumentsFromPreleveur} from '@/app/api/points-prelevement.js'
import SearchAutocomplete from '@/components/form/search-autocomplete.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const DynamicCheckbox = dynamic(
  () => import('@codegouvfr/react-dsfr/Checkbox'),
  {ssr: false}
)

const statutsExploitation = [
  'En activité',
  'Terminée',
  'Abandonnée',
  'Non renseigné'
]

const usagesExploitation = [
  'Eau potable',
  'Agriculture',
  'Camion citerne',
  'Eau embouteillée',
  'Hydroélectricité',
  'Industrie',
  'Thermalisme',
  'Non renseigné',
  'Autre'
]

// Sub-component to display documents selection
const DocumentsSection = ({selectedPreleveur, isLoadingDocuments, preleveurDocuments, selectedDocuments, onDocumentChange}) => (
  <Box sx={{mt: 3, mb: 3}}>
    <Typography variant='h6' sx={{mb: 2}}>
      Documents associés
    </Typography>

    {!selectedPreleveur && (
      <Alert
        small
        severity='info'
        description='Sélectionnez un préleveur pour voir les documents disponibles'
      />
    )}

    {selectedPreleveur && isLoadingDocuments && (
      <Box sx={{display: 'flex', alignItems: 'center', gap: 2}}>
        <CircularProgress size={20} />
        <Typography>Chargement des documents...</Typography>
      </Box>
    )}

    {selectedPreleveur && !isLoadingDocuments && preleveurDocuments.length === 0 && (
      <Alert
        small
        severity='info'
        description='Aucun document disponible pour ce préleveur'
      />
    )}

    {selectedPreleveur && !isLoadingDocuments && preleveurDocuments.length > 0 && (
      <DynamicCheckbox
        small
        legend='Sélectionner les documents à associer'
        options={preleveurDocuments.map(doc => ({
          value: doc._id,
          label: doc.nom || `Document ${doc._id}`,
          hintText: doc.type || '',
          nativeInputProps: {
            checked: selectedDocuments.includes(doc._id),
            onChange: e => onDocumentChange(e, doc._id)
          }
        }))}
      />
    )}
  </Box>
)

// Sub-component for statut select with tooltip
const StatutSelect = ({statut, setStatut, getValidationError}) => (
  <Select
    label={
      <>
        <span className='pr-2'>Statut *</span>
        <Tooltip
          kind='hover'
          title={
            <>
              <p className='p-2'><b><u>En activité</u> :</b> Exploitation qui fait actuellement encore l&apos;objet de prélèvement.</p>
              <p className='p-2'><b><u>Terminée</u> :</b> Exploitation arrêtée sans que cela soit dû à une raison technique particulière.</p>
              <p className='p-2'><b><u>Abandonnée</u> :</b> Il y a une raison technique qui ne permet plus l&apos;exploitation du point de prélèvement pour l&apos;usage visé (ex : contamination par les pesticides).</p>
              <p className='p-2'><b><u>Non renseigné</u> :</b> Pas d&apos;information sur l&apos;activité de l&apos;exploitation.</p>
            </>
          }
        />
      </>
    }
    options={statutsExploitation.map(s => ({
      value: s,
      label: s
    }))}
    placeholder='Sélectionner un statut'
    state={getValidationError('statut') ? 'error' : 'default'}
    stateRelatedMessage={getValidationError('statut')}
    nativeSelectProps={{
      value: statut,
      onChange(e) {
        setStatut(e.target.value)
      }
    }}
  />
)

const ExploitationCreationForm = ({idPoint, points, preleveurs}) => {
  const router = useRouter()

  const [error, setError] = useState(null)
  const [validationErrors, setValidationErrors] = useState([])
  const [isSubmitting, setIsSubmitting] = useState(false)

  // Form state
  const [selectedPoint, setSelectedPoint] = useState(null)
  const [selectedPreleveur, setSelectedPreleveur] = useState(null)
  const [dateDebut, setDateDebut] = useState('')
  const [dateFin, setDateFin] = useState('')
  const [statut, setStatut] = useState('')
  const [raisonAbandon, setRaisonAbandon] = useState('')
  const [usages, setUsages] = useState([])
  const [remarque, setRemarque] = useState('')
  const [selectedDocuments, setSelectedDocuments] = useState([])

  // Documents from selected preleveur
  const [preleveurDocuments, setPreleveurDocuments] = useState([])
  const [isLoadingDocuments, setIsLoadingDocuments] = useState(false)

  // Initialize point from URL param
  useEffect(() => {
    if (idPoint) {
      const point = points.find(p => p.id_point === Number.parseInt(idPoint, 10))
      if (point) {
        setSelectedPoint(point)
      }
    }
  }, [idPoint, points])

  // Fetch documents when preleveur changes
  useEffect(() => {
    const fetchDocuments = async () => {
      if (!selectedPreleveur) {
        setPreleveurDocuments([])
        setSelectedDocuments([])
        return
      }

      setIsLoadingDocuments(true)
      try {
        const docs = await getDocumentsFromPreleveur(selectedPreleveur._id)
        setPreleveurDocuments(docs || [])
      } catch {
        setPreleveurDocuments([])
      } finally {
        setIsLoadingDocuments(false)
      }
    }

    fetchDocuments()
  }, [selectedPreleveur])

  const handleUsageChange = (e, usage) => {
    setUsages(prev => {
      if (e.target.checked) {
        return [...prev, usage]
      }

      return prev.filter(u => u !== usage)
    })
  }

  const handleDocumentChange = (e, docId) => {
    setSelectedDocuments(prev => {
      if (e.target.checked) {
        return [...prev, docId]
      }

      return prev.filter(id => id !== docId)
    })
  }

  const getValidationError = field => validationErrors.find(err => err.path === field)?.message

  const isFormValid = selectedPoint && selectedPreleveur && dateDebut && statut

  const handleSubmit = async () => {
    setError(null)
    setValidationErrors([])
    setIsSubmitting(true)

    try {
      const payload = {
        point: selectedPoint._id,
        preleveur: selectedPreleveur._id,
        date_debut: dateDebut,
        date_fin: dateFin || null,
        statut,
        raison_abandon: statut === 'Abandonnée' ? raisonAbandon : null,
        usages: usages.length > 0 ? usages : null,
        remarque: remarque || null,
        documents: selectedDocuments.length > 0 ? selectedDocuments : []
      }

      const response = await createExploitation(payload)

      if (response.code === 400) {
        if (response.validationErrors) {
          setValidationErrors(response.validationErrors)
        } else {
          setError(response.message)
        }
      } else {
        router.push(`/exploitations/${response.id_exploitation}`)
      }
    } catch {
      setError('Une erreur est survenue')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div>
      <Typography variant='h3' sx={{pb: 5}}>
        Création d&apos;une exploitation
      </Typography>

      {/* Point de prélèvement */}
      <Box sx={{pb: 3}}>
        <p className='pb-2'>Associer un point de prélèvement *</p>
        <SearchBar
          label='Rechercher un point de prélèvement'
          renderInput={({className, id, placeholder, type}) => (
            <SearchAutocomplete
              options={points.map(point => ({
                point,
                label: `${point.id_point} - ${point.nom}`
              }))}
              defaultValue={selectedPoint
                ? `${selectedPoint.id_point} - ${selectedPoint.nom}`
                : null}
              className={className}
              id={id}
              placeholder={placeholder}
              type={type}
              onChange={(e, value) => setSelectedPoint(value?.point || null)}
            />
          )}
        />
        {getValidationError('point') && (
          <p className='text-red-500 text-sm mt-1'>{getValidationError('point')}</p>
        )}
      </Box>

      {/* Préleveur */}
      <Box sx={{pb: 3}}>
        <p className='pb-2'>Associer un préleveur *</p>
        <SearchBar
          label='Rechercher un préleveur'
          renderInput={({className, id, placeholder, type}) => (
            <SearchAutocomplete
              options={preleveurs.map(preleveur => ({
                preleveur,
                label: displayPreleveur(preleveur)
              }))}
              className={className}
              id={id}
              placeholder={placeholder}
              type={type}
              onChange={(e, value) => setSelectedPreleveur(value?.preleveur || null)}
            />
          )}
        />
        {getValidationError('preleveur') && (
          <p className='text-red-500 text-sm mt-1'>{getValidationError('preleveur')}</p>
        )}
      </Box>

      {/* Dates */}
      <div className='w-full grid grid-cols-2 gap-4'>
        <Input
          label="Début d'exploitation *"
          state={getValidationError('date_debut') ? 'error' : 'default'}
          stateRelatedMessage={getValidationError('date_debut')}
          nativeInputProps={{
            type: 'date',
            value: dateDebut,
            onChange: e => setDateDebut(e.target.value)
          }}
        />
        <Input
          label="Fin d'exploitation"
          state={getValidationError('date_fin') ? 'error' : 'default'}
          stateRelatedMessage={getValidationError('date_fin')}
          nativeInputProps={{
            type: 'date',
            value: dateFin,
            onChange: e => setDateFin(e.target.value)
          }}
        />
      </div>

      {/* Statut */}
      <StatutSelect
        getValidationError={getValidationError}
        setStatut={setStatut}
        statut={statut}
      />

      {/* Raison abandon */}
      {statut === 'Abandonnée' && (
        <Input
          textArea
          label="Raison de l'abandon"
          nativeTextAreaProps={{
            placeholder: 'Indiquer la raison de l&apos;abandon',
            value: raisonAbandon,
            onChange: e => setRaisonAbandon(e.target.value)
          }}
        />
      )}

      {/* Usages */}
      <DynamicCheckbox
        small
        legend='Usages'
        options={usagesExploitation.map(usage => ({
          value: usage,
          label: usage,
          nativeInputProps: {
            checked: usages.includes(usage),
            onChange: e => handleUsageChange(e, usage)
          }
        }))}
        orientation='horizontal'
      />
      {getValidationError('usages') && (
        <p className='text-red-500 text-sm mt-1'>{getValidationError('usages')}</p>
      )}

      {/* Documents */}
      <DocumentsSection
        isLoadingDocuments={isLoadingDocuments}
        preleveurDocuments={preleveurDocuments}
        selectedDocuments={selectedDocuments}
        selectedPreleveur={selectedPreleveur}
        onDocumentChange={handleDocumentChange}
      />

      {/* Remarque */}
      <Input
        textArea
        label='Remarque'
        nativeTextAreaProps={{
          placeholder: 'Entrer une remarque',
          value: remarque,
          onChange: e => setRemarque(e.target.value)
        }}
      />

      {/* Errors */}
      {error && (
        <Alert
          severity='error'
          title='Un problème est survenu'
          description={error}
          className='mt-4'
        />
      )}

      {validationErrors?.length > 0 && !validationErrors.every(err => err.path) && (
        <Alert
          severity='error'
          title={validationErrors.length === 1 ? 'Problème de validation' : 'Problèmes de validation'}
          description={
            <ul>
              {validationErrors.filter(err => !err.path).map(err => (
                <li key={err.message}>{err.message}</li>
              ))}
            </ul>
          }
          className='mt-4'
        />
      )}

      {/* Submit button */}
      <div className='w-full flex justify-center p-5 mb-8'>
        <Button
          disabled={!isFormValid || isSubmitting}
          onClick={handleSubmit}
        >
          {isSubmitting ? 'Création en cours...' : 'Valider la création de l&apos;exploitation'}
        </Button>
      </div>
    </div>
  )
}

export default ExploitationCreationForm
