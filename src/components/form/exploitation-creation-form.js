/* eslint-disable camelcase */
'use client'

import {useState} from 'react'

import {Alert} from '@codegouvfr/react-dsfr/Alert'
import {Button} from '@codegouvfr/react-dsfr/Button'
import {Input} from '@codegouvfr/react-dsfr/Input'
import {SearchBar} from '@codegouvfr/react-dsfr/SearchBar'
import {Select} from '@codegouvfr/react-dsfr/SelectNext'
import {Tooltip} from '@codegouvfr/react-dsfr/Tooltip'
import {Typography, Box} from '@mui/material'
import dynamic from 'next/dynamic'
import {useRouter} from 'next/navigation'

import SearchAutocomplete from '@/components/form/search-autocomplete.js'
import DividerSection from '@/components/ui/DividerSection/index.js'
import FormErrors from '@/components/ui/FormErrors/index.js'
import useFormSubmit from '@/hook/use-form-submit.js'
import {createExploitationAction} from '@/server/actions/index.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

const DynamicCheckbox = dynamic(
  () => import('@codegouvfr/react-dsfr/Checkbox'),
  {ssr: false}
)

const statutsExploitation = [
  'En activité',
  'Terminée',
  'Abandonnée',
  'Non renseigné'
]

const usagesExploitation = [
  'Eau potable',
  'Agriculture',
  'Camion citerne',
  'Eau embouteillée',
  'Hydroélectricité',
  'Industrie',
  'Thermalisme',
  'Non renseigné',
  'Autre'
]

// Sub-component for point selection with loading states
const PointSelectionSection = ({
  pointsPrelevement,
  selectedPoint,
  setSelectedPoint,
  getFieldError
}) => {
  if (pointsPrelevement.length === 0) {
    return (
      <Alert
        small
        severity='warning'
        description="Ce préleveur n'a pas encore de point de prélèvement associé. Vous pouvez en créer un depuis la page du préleveur."
      />
    )
  }

  return (
    <Box>
      <p className='pb-2'>Associer un point de prélèvement *</p>
      <SearchBar
        label='Rechercher un point de prélèvement'
        renderInput={({className, id, placeholder, type}) => (
          <SearchAutocomplete
            options={pointsPrelevement.map(point => ({
              point,
              label: `${point.id_point} - ${point.nom}`
            }))}
            value={selectedPoint
              ? `${selectedPoint.id_point} - ${selectedPoint.nom}`
              : null}
            className={className}
            id={id}
            placeholder={placeholder}
            type={type}
            onChange={(e, value) => setSelectedPoint(value?.point || null)}
          />
        )}
      />
      {getFieldError('point') && (
        <p className='text-red-500 text-sm mt-1'>{getFieldError('point')}</p>
      )}
    </Box>
  )
}

// Sub-component for statut select with tooltip
const StatutSelect = ({statut, setStatut, fieldError}) => (
  <Select
    label={
      <>
        <span className='pr-2'>Statut *</span>
        <Tooltip
          kind='hover'
          title={
            <>
              <p className='p-2'><b><u>En activité</u> :</b> Exploitation qui fait actuellement encore l&apos;objet de prélèvement.</p>
              <p className='p-2'><b><u>Terminée</u> :</b> Exploitation arrêtée sans que cela soit dû à une raison technique particulière.</p>
              <p className='p-2'><b><u>Abandonnée</u> :</b> Il y a une raison technique qui ne permet plus l&apos;exploitation du point de prélèvement pour l&apos;usage visé (ex : contamination par les pesticides).</p>
              <p className='p-2'><b><u>Non renseigné</u> :</b> Pas d&apos;information sur l&apos;activité de l&apos;exploitation.</p>
            </>
          }
        />
      </>
    }
    options={statutsExploitation.map(s => ({
      value: s,
      label: s
    }))}
    placeholder='Sélectionner un statut'
    state={fieldError('statut') ? 'error' : 'default'}
    stateRelatedMessage={fieldError('statut')}
    nativeSelectProps={{
      value: statut,
      onChange: e => setStatut(e.target.value)
    }}
  />
)

const ExploitationCreationForm = ({defaultPreleveur, defaultPointPrelevement, pointsPrelevement, preleveurs}) => {
  const router = useRouter()
  const {isSubmitting, error, validationErrors, resetErrors, withSubmit, getFieldError} = useFormSubmit()

  // Form state
  const [selectedPoint, setSelectedPoint] = useState(defaultPointPrelevement || null)
  const [selectedPreleveur, setSelectedPreleveur] = useState(defaultPreleveur || null)
  const [dateDebut, setDateDebut] = useState('')
  const [dateFin, setDateFin] = useState('')
  const [statut, setStatut] = useState('')
  const [raisonAbandon, setRaisonAbandon] = useState('')
  const [usages, setUsages] = useState([])
  const [remarque, setRemarque] = useState('')

  const handleUsageChange = (e, usage) => {
    setUsages(prev => {
      if (e.target.checked) {
        return [...prev, usage]
      }

      return prev.filter(u => u !== usage)
    })
  }

  const isFormValid = selectedPoint && selectedPreleveur && dateDebut && statut

  const handleSubmit = withSubmit(
    async () => {
      const payload = {
        point: selectedPoint._id,
        preleveur: selectedPreleveur._id,
        date_debut: dateDebut,
        date_fin: dateFin || null,
        statut,
        raison_abandon: statut === 'Abandonnée' ? raisonAbandon : null,
        usages: usages.length > 0 ? usages : null,
        remarque: remarque || null
      }
      const response = await createExploitationAction(payload)
      if (!response.success) {
        throw response
      }

      return response.data
    },
    {
      successIndicator: 'id_exploitation',
      onSuccess(response) {
        if (defaultPreleveur) {
          router.push(`/preleveurs/${defaultPreleveur.id_preleveur}`)
        } else {
          router.push(`/exploitations/${response.id_exploitation}`)
        }
      }
    }
  )

  return (
    <div>
      <Typography variant='h3' sx={{pb: 3}}>
        Création d&apos;une exploitation
      </Typography>

      {/* Préleveur */}
      <Box sx={{pb: 3}}>
        <p className='pb-2'>Sélectionner un préleveur *</p>
        <SearchBar
          label='Rechercher un préleveur'
          renderInput={({className, id, placeholder, type}) => (
            <SearchAutocomplete
              options={preleveurs.map(preleveur => ({
                preleveur,
                label: displayPreleveur(preleveur),
                key: preleveur._id
              }))}
              defaultValue={selectedPreleveur ? displayPreleveur(selectedPreleveur) : null}
              className={className}
              id={id}
              placeholder={placeholder}
              type={type}
              onChange={(e, value) => setSelectedPreleveur(value?.preleveur || null)}
            />
          )}
        />
        {getFieldError('preleveur') && (
          <p className='text-red-500 text-sm mt-1'>{getFieldError('preleveur')}</p>
        )}
      </Box>

      {/* Point de prélèvement */}
      <Box sx={{pb: 3}}>
        <PointSelectionSection
          pointsPrelevement={pointsPrelevement}
          getFieldError={getFieldError}
          selectedPoint={selectedPoint}
          setSelectedPoint={setSelectedPoint}
        />
      </Box>

      {/* Période et Statut Section */}
      <DividerSection title='Période et statut'>
        <div className='w-full grid grid-cols-2 gap-4'>
          <Input
            label="Début d'exploitation *"
            state={getFieldError('date_debut') ? 'error' : 'default'}
            stateRelatedMessage={getFieldError('date_debut')}
            nativeInputProps={{
              type: 'date',
              value: dateDebut,
              onChange: e => setDateDebut(e.target.value)
            }}
          />
          <Input
            label="Fin d'exploitation"
            state={getFieldError('date_fin') ? 'error' : 'default'}
            stateRelatedMessage={getFieldError('date_fin')}
            nativeInputProps={{
              type: 'date',
              value: dateFin,
              onChange: e => setDateFin(e.target.value)
            }}
          />
        </div>

        <StatutSelect
          fieldError={getFieldError}
          setStatut={setStatut}
          statut={statut}
        />

        {statut === 'Abandonnée' && (
          <Input
            textArea
            label='Raison de l&apos;abandon'
            nativeTextAreaProps={{
              placeholder: 'Indiquer la raison de l&apos;abandon',
              value: raisonAbandon,
              onChange: e => setRaisonAbandon(e.target.value)
            }}
          />
        )}
      </DividerSection>

      {/* Usages Section */}
      <DividerSection title='Usages'>
        <DynamicCheckbox
          small
          legend='Sélectionner les usages de cette exploitation'
          options={usagesExploitation.map(usage => ({
            value: usage,
            label: usage,
            nativeInputProps: {
              checked: usages.includes(usage),
              onChange: e => handleUsageChange(e, usage)
            }
          }))}
          orientation='horizontal'
        />
        {getFieldError('usages') && (
          <p className='text-red-500 text-sm mt-1'>{getFieldError('usages')}</p>
        )}
      </DividerSection>

      {/* Remarque Section */}
      <DividerSection title='Informations complémentaires'>
        <Input
          textArea
          label='Remarque'
          nativeTextAreaProps={{
            placeholder: 'Entrer une remarque',
            value: remarque,
            onChange: e => setRemarque(e.target.value)
          }}
        />
      </DividerSection>

      {/* Errors */}
      <FormErrors
        error={error}
        validationErrors={validationErrors.filter(e => !e.path)}
        onClose={resetErrors}
      />

      {/* Submit button */}
      <div className='w-full flex justify-center p-5 mb-8'>
        <Button
          disabled={!isFormValid || isSubmitting}
          onClick={handleSubmit}
        >
          {isSubmitting ? 'Création en cours...' : 'Valider la création de l’exploitation'}
        </Button>
      </div>
    </div>
  )
}

export default ExploitationCreationForm
