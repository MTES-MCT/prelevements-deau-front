'use client'

import ExploitationsListItem from './exploitations-list-item.js'

import SectionCard from '@/components/ui/SectionCard/index.js'
import {sortByEndDate, sortByRecurrence, sortByStatus} from '@/lib/exploitation.js'
import {getNewExploitationURL} from '@/lib/urls.js'

/*
  Sorts exploitations, first by status (active first), then by end date (most recent first).
  Start dates with 0001 as year are put at the end of their status group.
 */
function sortExploitations(exploitations) {
  return [...exploitations].sort((a, b) => (
    sortByStatus(a, b)
      || sortByEndDate(a, b)
      || sortByRecurrence(a, b)
  ))
}

/**
 * Displays a list of exploitations. If the exploitation name is empty, it will try to show infos from the preleveur.
 * @param hidePreleveur If true, the preleveur info will be hidden in the metas
 * @param {Object[]} exploitations - List of exploitations to display
 * @param {string} createHref - Link to the exploitation creation page
 */
const ExploitationsList = ({hidePreleveur, exploitations = [], createHref}) => {
  const sortedExploitations = sortExploitations(exploitations)

  return (
    <SectionCard title='Exploitations' icon='ri-map-pin-user-line' buttonProps={{
      children: 'Créer une exploitation',
      iconId: 'fr-icon-add-line',
      priority: 'secondary',
      linkProps: {
        href: createHref || getNewExploitationURL()
      }
    }}
    >
      {
        sortedExploitations.length > 0 ? sortedExploitations.map((exploitation, index) => (
          <ExploitationsListItem
            key={exploitation.id}
            exploitation={exploitation}
            preleveur={exploitation.declarant}
            hidePreleveur={hidePreleveur}
            index={index}
          />
        )) : (<div>
          <i>Pas d’exploitation</i>
        </div>)
      }
    </SectionCard>
  )
}

export default ExploitationsList
