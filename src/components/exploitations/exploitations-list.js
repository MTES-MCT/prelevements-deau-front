'use client'

import ExploitationsListItem from './exploitations-list-item.js'

import SectionCard from '@/components/ui/SectionCard/index.js'

/*
  Sorts exploitations, first by status (active first), then by end date (most recent first).
  Start dates with 0001 as year are put at the end of their status group.
 */
function sortExploitations(exploitations) {
  return [...exploitations].sort((a, b) => {
    // Sort by status
    if (a.statut === 'En activité' && b.statut !== 'En activité') {
      return -1
    }

    if (a.statut !== 'En activité' && b.statut === 'En activité') {
      return 1
    }

    // Sort by end date
    const endDateA = a.date_fin ? new Date(a.date_fin) : null
    const endDateB = b.date_fin ? new Date(b.date_fin) : null
    if (endDateA && endDateB) {
      if (endDateA > endDateB) {
        return 1
      }

      if (endDateA < endDateB) {
        return -1
      }
    } else if (endDateA) {
      return -1
    } else if (endDateB) {
      return 1
    }

    // '0001' year case
    const yearA = a.date_debut ? new Date(a.date_debut).getFullYear() : null
    const yearB = b.date_debut ? new Date(b.date_debut).getFullYear() : null
    if (yearA === 1 && yearB !== 1) {
      return 1
    }

    if (yearA !== 1 && yearB === 1) {
      return -1
    }

    if (a.date_debut && b.date_debut) {
      if (a.date_debut > b.date_debut) {
        return -1
      }

      if (a.date_debut < b.date_debut) {
        return 1
      }
    }

    return 0
  })
}

/**
 * Displays a list of exploitations. If the exploitation name is empty, it will try to show infos from the preleveur.
 * @param hidePreleveur If true, the preleveur info will be hidden in the metas
 * @param {Object[]} exploitations - List of exploitations to display
 * @param {Object[]} preleveurs - List of preleveurs to get additional info if exploitation name is empty
 */
const ExploitationsList = ({hidePreleveur, exploitations = [], preleveurs = []}) => {
  const sortedExploitations = sortExploitations(exploitations)

  return (
    <SectionCard title='Exploitations' icon='ri-map-pin-user-line' buttonProps={{
      children: 'Créer une exploitation',
      iconId: 'fr-icon-add-line',
      priority: 'secondary',
      linkProps: {
        href: '/exploitations/new'
      }
    }}
    >
      {
        sortedExploitations.length > 0 ? sortedExploitations.map((exploitation, index) => {
          const preleveur = preleveurs.find(p => p._id === exploitation.preleveur)
          return (
            <ExploitationsListItem
              key={exploitation._id}
              exploitation={exploitation}
              preleveur={preleveur}
              hidePreleveur={hidePreleveur}
              index={index}
            />
          )
        }) : (<div>
          <i>Pas d’exploitation</i>
        </div>)
      }
    </SectionCard>
  )
}

export default ExploitationsList
