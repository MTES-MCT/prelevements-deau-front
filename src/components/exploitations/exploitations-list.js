'use client'

import ExploitationsListItem from './exploitations-list-item.js'

import SectionCard from '@/components/ui/SectionCard/index.js'

// Sorts exploitations by end date and status
function sortExploitations(exploitations) {
  const orderedByDateFinExploitations = [...exploitations].sort((a, b) => {
    if (a.date_fin === undefined) {
      return -1
    }

    if (b.date_fin === undefined) {
      return 1
    }

    return b.id_exploitation - a.id_exploitation
  })

  return orderedByDateFinExploitations.sort((a, b) => {
    if (a.statut === 'En activité' && b.statut === 'En activité') {
      return new Date(b.date_debut) - new Date(a.date_debut)
    }

    if (a.statut === 'En activité' && b.statut !== 'En activité') {
      return -1
    }

    if (a.statut !== 'En activité' && b.statut === 'En activité') {
      return 1
    }

    return 0
  })
}

/**
 * Displays a list of exploitations. If the exploitation name is empty, it will try to show infos from the preleveur.
 * @param hidePreleveur If true, the preleveur info will be hidden in the metas
 * @param {Object[]} exploitations - List of exploitations to display
 * @param {Object[]} preleveurs - List of preleveurs to get additional info if exploitation name is empty
 */
const ExploitationsList = ({hidePreleveur, exploitations = [], preleveurs = []}) => {
  const sortedExploitations = sortExploitations(exploitations)

  return (
    <SectionCard title='Exploitations' icon='ri-map-pin-user-line' buttonProps={{
      children: 'Créer une exploitation',
      iconId: 'fr-icon-add-line',
      priority: 'secondary',
      linkProps: {
        href: '/exploitations/new'
      }
    }}
    >
      {
        sortedExploitations.length > 0 ? sortedExploitations.map((exploitation, index) => {
          const preleveur = preleveurs.find(p => p._id === exploitation.preleveur)
          return (
            <ExploitationsListItem
              key={exploitation._id}
              exploitation={exploitation}
              preleveur={preleveur}
              hidePreleveur={hidePreleveur}
              index={index}
            />
          )
        }) : (<div>
          <i>Pas d’exploitation</i>
        </div>)
      }
    </SectionCard>
  )
}

export default ExploitationsList
