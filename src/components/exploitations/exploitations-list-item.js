import Link from 'next/link.js'

import ListItem from '@/components/ui/ListItem/index.js'
import {formatDateRange} from '@/lib/format-date.js'
import {usageIcons} from '@/lib/points-prelevement.js'
import {displayPreleveur} from '@/utils/preleveurs.js'

function getPreleveurInfo(preleveur) {
  if (!preleveur) {
    return null
  }

  if (preleveur.nom) {
    return `${preleveur.civilite || ''} ${preleveur.nom} ${preleveur.prenom || ''}`
  }

  return preleveur.raison_sociale || preleveur.sigle
}

export const severityMap = {
  'En activité': 'info',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const ExploitationsListItem = ({exploitation, preleveur, index, hidePreleveur = false}) => {
  const metas = []

  if (!hidePreleveur) {
    metas.push({content: displayPreleveur(preleveur), iconId: 'fr-icon-user-line'})
  }

  metas.push({
    content: formatDateRange(exploitation.date_debut, exploitation.date_fin),
    iconId: 'fr-icon-calendar-2-line'
  })

  return (
    <Link href={`/exploitations/${exploitation.id_exploitation}`}>
      <ListItem
        border
        background={index % 2 === 0 ? 'primary' : 'secondary'}
        tags={[{label: exploitation.statut, severity: severityMap[exploitation.statut], hasIcon: false}]}
        title={exploitation.point.nom || getPreleveurInfo(preleveur)}
        rightIcons={exploitation.usages.map(usage => (
          {label: usage, icon: usageIcons[usage]}
        ))}
        metas={metas}
      />
    </Link>

  )
}

export default ExploitationsListItem
